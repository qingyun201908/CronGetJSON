name: events Download

on:
  schedule:
    - cron: '0 5 * * *'  # UTC 4:00 (åŒ—äº¬æ—¶é—´12:00)
  workflow_dispatch:

env:
  # é›†ä¸­ç®¡ç†JSONæºåˆ—è¡¨ï¼ˆåç§°|URLï¼‰
  JSON_SOURCES: >
    events|https://profile-api.hydev.org/exports/hykilp/posts.json
  DATA_DIR: './data'

jobs:
  download-json:
    runs-on: ubuntu-latest
    outputs:
      json-updated: ${{ steps.collect-results.outputs.json-updated }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´æäº¤åŽ†å²

      - name: Setup directories
        run: |
          TODAY=$(date -u +'%Y-%m-%d')
          echo "DATE_TAG=$TODAY" >> $GITHUB_ENV
          mkdir -p "$DATA_DIR/$TODAY"
        
      - name: Download JSON files
        id: download
        run: |
          set -euo pipefail  # å¯ç”¨ä¸¥æ ¼é”™è¯¯æ£€æŸ¥
          IFS=$'\n'
          any_updated=false
          
          for source in $JSON_SOURCES; do
            name="${source%%|*}"
            url="${source##*|}"
            dir_path="$DATA_DIR/$DATE_TAG/$name"
            
            echo "ðŸ“¥ Downloading $name.json"
            mkdir -p "$dir_path"
            curl -sSfL "$url" -o "$dir_path/data.json"
            
            if jq empty "$dir_path/data.json" >/dev/null 2>&1; then
              echo "âœ… Valid JSON: $name"
              any_updated=true
            else
              echo "âŒ Invalid JSON: $name" >&2
              rm -f "$dir_path/data.json"
              exit 1
            fi
          done
          
          echo "json-updated=$any_updated" >> $GITHUB_OUTPUT
        env:
          JSON_SOURCES: ${{ env.JSON_SOURCES }}

      - name: Collect results
        id: collect-results
        run: |
          echo "json-updated=${{ steps.download.outputs.json-updated }}" >> $GITHUB_OUTPUT

      - name: Commit updates
        if: ${{ steps.collect-results.outputs.json-updated == 'true' }}
        run: |
          git config user.name "Automated JSON Updater"
          git config user.email "actions@users.noreply.github.com"
          git add "$DATA_DIR"
          
          if git diff-index --quiet HEAD --; then
            echo "ðŸŸ¢ No changes detected"
          else
            git commit -m "ðŸ“Š JSON data update: ${{ env.DATE_TAG }}"
            git push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
