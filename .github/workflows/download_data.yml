name: Daily JSON Download

on:
  # å®šæ—¶è§¦å‘å™¨ï¼ˆåŒ—äº¬æ—¶é—´æ¯å¤©12:00ï¼‰
  schedule:
    - cron: '0 5 * * *'  # UTCæ—¶é—´4:00 (åŒ—äº¬æ—¶é—´12:00)

  # æ‰‹åŠ¨è§¦å‘é€‰é¡¹
  workflow_dispatch:

jobs:
  download-json:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # 2. è®¾ç½®ä¸‹è½½ç›®å½•
      - name: Prepare directory
        run: |
          TODAY=$(date -u +'%Y-%m-%d')
          mkdir -p "./data/$TODAY"
          echo "DIR_PATH=./data/$TODAY" >> $GITHUB_ENV
          echo "JSON_UPDATED=false" >> $GITHUB_ENV  # åˆå§‹åŒ–ä¸ºfalse

      # 3. å®šä¹‰JSONæºåˆ—è¡¨
      - name: Setup JSON sources
        id: set-json-sources
        run: |
          # å®šä¹‰è¦ä¸‹è½½çš„JSONæºï¼Œæ ¼å¼ï¼šname|url
          echo "sources='"
          echo "stats|https://profile-content.hydev.org/content/generated/metas.json"
          echo "users|https://profile-content.hydev.org/content/generated/friends/friends.json"
          echo "events|https://profile-api.hydev.org/exports/hykilp/posts.json"
          echo "'" >> $GITHUB_OUTPUT
        # åœ¨shellä¸­è¾“å‡ºå€¼
        shell: bash

      # 4. å¾ªç¯ä¸‹è½½æ‰€æœ‰JSONæ–‡ä»¶
      - name: Download multiple JSONs
        run: |
          # ä½¿ç”¨IFSå¤„ç†å¤šè¡Œè¾“å…¥
          IFS=$'\n'
          for source in ${{ steps.set-json-sources.outputs.sources }}
          do
            # æ‹†åˆ†æ¯è¡Œçš„nameå’Œurl
            name=$(echo "$source" | cut -d'|' -f1)
            url=$(echo "$source" | cut -d'|' -f2)
            
            echo "ğŸ“¥ Downloading $name.json from $url"
            
            # åˆ›å»ºå­ç›®å½•å¹¶ä¸‹è½½
            mkdir -p "$DIR_PATH/$name"
            curl -sSf "$url" -o "$DIR_PATH/$name/data.json"
            
            # éªŒè¯JSONæ ¼å¼
            if jq empty "$DIR_PATH/$name/data.json"; then
              echo "âœ… $name.json downloaded and validated"
              echo "JSON_UPDATED=true" >> $GITHUB_ENV
            else
              echo "âŒ Invalid JSON format for $name.json"
              exit 1
            fi
          done
        env:
          DIR_PATH: ${{ env.DIR_PATH }}

      # 5. æäº¤æ›´æ”¹ï¼ˆä»…å½“æœ‰æ›´æ–°æ—¶ï¼‰
      - name: Commit changes
        if: env.JSON_UPDATED == 'true'
        run: |
          git config user.name "GitHub JSON Downloader"
          git config user.email "json-downloader@noreply.github.com"
          git add ./data/
          git commit -m "JSON data update: $(date -u +'%Y-%m-%d')"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
